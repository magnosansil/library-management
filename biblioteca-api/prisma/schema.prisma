// Prisma Schema para Biblioteca API
// Este schema pode ser usado para gerenciar o banco de dados independentemente do JPA

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Book {
  isbn                    String        @id @db.VarChar(50)
  title                   String
  author                  String
  coverImageUrl           String?       @map("cover_image_url") @db.VarChar(500)
  keywords                String?       @db.VarChar(500)
  synopsis                String?       @db.Text
  entryDate               DateTime      @default(now()) @map("entry_date")
  quantity                Int           @default(0)
  activeReservationsCount Int           @map("active_reservations_count") @default(0)
  loans                   Loan[]
  reservations            Reservation[]

  @@map("books")
}

model Student {
  matricula         String        @id @db.VarChar(50)
  nome              String
  cpf               String        @unique @db.VarChar(11)
  dataNascimento    DateTime      @map("data_nascimento")
  reservationsCount Int           @map("reservations_count") @default(0)
  loans             Loan[]
  reservations      Reservation[]

  @@map("students")
}

model Loan {
  id            BigInt    @id @default(autoincrement())
  studentMatricula String    @map("student_matricula") @db.VarChar(50)
  bookIsbn      String    @map("book_isbn") @db.VarChar(50)
  loanDate      DateTime  @map("loan_date") // DATETIME - data e hora do empréstimo
  dueDate       DateTime  @map("due_date") // DATETIME - calculado automaticamente
  returnDate    DateTime? @map("return_date")
  status        String
  overdueDays   Int?      @map("overdue_days") // Dias de atraso (calculado na devolução)
  fineAmount    Int?      @map("fine_amount") // Valor da multa em centavos (calculado na devolução)
  createdAt     DateTime  @default(now()) @map("created_at")

  student       Student   @relation(fields: [studentMatricula], references: [matricula])
  book          Book      @relation(fields: [bookIsbn], references: [isbn])

  @@map("loans")
}

model LibrarySettings {
  id                  BigInt  @id @default(1)
  loanPeriodDays      Int     @map("loan_period_days") @default(14)
  maxLoansPerStudent  Int     @map("max_loans_per_student") @default(3)
  finePerDay          Int     @map("fine_per_day") @default(100) // Multa por dia de atraso (em centavos)

  @@map("library_settings")
}

model Reservation {
  id              BigInt    @id @default(autoincrement())
  bookIsbn        String    @map("book_isbn") @db.VarChar(50)
  studentMatricula String    @map("student_matricula") @db.VarChar(50)
  reservationDate DateTime  @map("reservation_date")
  queuePosition   Int       @map("queue_position")
  status          String    @default("ACTIVE") // ACTIVE, CANCELLED, FULFILLED
  createdAt       DateTime  @default(now()) @map("created_at")

  book            Book      @relation(fields: [bookIsbn], references: [isbn])
  student         Student   @relation(fields: [studentMatricula], references: [matricula])

  @@map("reservations")
}


